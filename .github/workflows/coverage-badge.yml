on:
  pull_request:
  push:
      
name: Test and update coverage
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Go setup
        uses: actions/setup-go@v3
        with:
          go-version: '1.19.x'
          cache: true

      - name: Go test
        run: go test ./... -count 1 -race -coverprofile coverage.out -covermode atomic

      - name: Calculate coverage
        run: |
          echo "COVERAGE=$(go tool cover -func coverage.out | tail -1 | grep -Eo '[0-9]+\.[0-9]')" >> $GITHUB_ENV
          echo "coverage: $COVERAGE% of statements"

      - name: Add PR comment
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            **Branch tests coverage: ${{ env.COVERAGE }}**

      - name: Create coverage badge
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          if awk "BEGIN {exit !($COVERAGE >= 90)}"; then
            COLOR=brightgreen
          elif awk "BEGIN {exit !($COVERAGE >= 80)}"; then
            COLOR=green
          elif awk "BEGIN {exit !($COVERAGE >= 70)}"; then
            COLOR=yellowgreen
          elif awk "BEGIN {exit !($COVERAGE >= 60)}"; then
            COLOR=yellow
          elif awk "BEGIN {exit !($COVERAGE >= 50)}"; then
            COLOR=orange
          else
            COLOR=red
          fi

          curl -s "https://img.shields.io/badge/coverage-$COVERAGE%25-$COLOR" > coverage.svg
          go tool cover -html coverage.out -o coverage.html

          mv coverage.svg ./.github/wiki/
          mv coverage.html ./.github/wiki/

      - name: Commit to Wiki  
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          repository: ./.github/wiki/
          skip_fetch: true
          skip_checkout: true
